<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snake</title>
  </head>
  <body>
    <canvas id="game-field" width="500" height="500"></canvas>
  </body>
  <script>
    const screen = document.getElementById("game-field");

    const rows = 25;
    const cols = 25;

    //const gameGrid = Array.from(Array(rows), () => new Array(cols).fill(0));

    let snake = [
      [6, 0],
      [5, 0],
      [4, 0],
      [3, 0],
      [2, 0],
      [1, 0],
      [0, 0],
    ];

    // TODO Fruit generator

    // TODO Score counter

    function checkSelfCollision() {
      let snakeBody = snake.slice(1);
      let snakeHead = snake[0].concat();

      return snakeBody.some(
        (segment) => segment[0] === snakeHead[0] && segment[1] === snakeHead[1]
      );
    }

    function checkEdgeCollision() {
      let head = snake[0].concat();
      return head[0] > rows - 1 ? true
        : head[0] < 0 ? true
        : head[1] > cols - 1 ? true
        : head[1] < 0 ? true
        : false
    }

    function cycleGame(direction) {
      // TODO Fruit pickup detection
      // TODO Refactor to stop mutation of snake array
      // Maybe add sped up replay behind game over screen
      let headLastPos = snake[0].concat();

      snake.pop();
      snake.unshift([
        (headLastPos[0] += direction[0]),
        (headLastPos[1] += direction[1]),
      ]);

      if (checkSelfCollision() || checkEdgeCollision()) alert("Game Over");

      return snake;
    }

    function handleInput({ code }) {
      switch (code) {
        case "KeyW":
        case "ArrowUp":
          cycleGame([0, -1]);
          break;
        case "KeyD":
        case "ArrowRight":
          cycleGame([1, -0]);
          break;
        case "KeyS":
        case "ArrowDown":
          cycleGame([0, 1]);
          break;
        case "KeyA":
        case "ArrowLeft":
          cycleGame([-1, 0]);
          break;
      }
    }

    function drawScreen(snake, fruitPos) {
      // TODO Optimize draw function
      if (screen.getContext) {
        const ctx = screen.getContext("2d");

        const tileWidth = screen.offsetWidth / cols;
        const tileHeight = screen.offsetHeight / rows;

        for (let x = 0; x < rows; x++) {
          for (let y = 0; y < cols; y++) {
            ctx.fillStyle = snake.find(
              (segment) => segment[0] === x && segment[1] === y
            )
              ? "white"
              : "grey";
            ctx.fillRect(x * tileWidth, y * tileHeight, tileWidth, tileHeight);
          }
        }
      }
    }

    window.addEventListener("keydown", (key) => handleInput(key));

    window.setInterval(() => {
      drawScreen(snake);
    }, 16.7);
  </script>
  <style>
    body {
      height: 100vh;
      width: 100vw;
      margin: 0;
      background: #000;
    }
    #game-field {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
      background: #222;
    }
  </style>
</html>
